<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایجاد قالب پیام جدید</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .variable-tag {
            transition: all 0.3s ease;
        }
        .variable-tag:hover {
            transform: translateY(-1px);
        }
        .character-counter {
            transition: color 0.3s ease;
        }
        .character-counter.warning {
            color: #f59e0b;
        }
        .character-counter.danger {
            color: #ef4444;
        }
        .preview-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 mb-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">ایجاد قالب پیام جدید</h1>
                    <p class="text-xs text-gray-600 dark:text-gray-400">قالب پیامک یا پیام جدید ایجاد کنید</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="window.history.back()"
                        class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition text-sm font-medium">
                    <i class="fas fa-arrow-right ml-2"></i>
                    بازگشت
                </button>
                <button onclick="saveAsDraft()"
                        class="px-4 py-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 transition text-sm font-medium">
                    <i class="fas fa-save ml-2"></i>
                    ذخیره پیش‌نویس
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Main Form -->
        <div class="lg:col-span-2">
            <form id="createTemplateForm" class="space-y-8">

                <!-- Basic Information -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-info-circle text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">اطلاعات پایه</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Template Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-tag text-blue-500 ml-2"></i>
                                نام قالب *
                            </label>
                            <input type="text" id="templateName" name="name" required
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"
                                   placeholder="نام قالب را وارد کنید...">
                            <div id="nameError" class="hidden text-red-500 text-sm mt-1"></div>
                        </div>

                        <!-- Body ID -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-code text-green-500 ml-2"></i>
                                شناسه قالب (bodyId) *
                            </label>
                            <input type="text" id="bodyId" name="bodyId" required
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"
                                   placeholder="مثال: WELCOME_001"
                                   oninput="validateBodyId(this.value)">
                            <div id="bodyIdError" class="hidden text-red-500 text-sm mt-1"></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                فقط حروف انگلیسی، اعداد و خط تیره مجاز است
                            </div>
                        </div>
                    </div>

                    <!-- Template Category -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-folder text-orange-500 ml-2"></i>
                            دسته‌بندی
                        </label>
                        <select id="category" name="category"
                                class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                            <option value="">انتخاب دسته‌بندی...</option>
                            <option value="welcome">خوش‌آمدگویی</option>
                            <option value="verification">تایید هویت</option>
                            <option value="promotional">تبلیغاتی</option>
                            <option value="transactional">تراکنشی</option>
                            <option value="notification">اطلاع‌رسانی</option>
                            <option value="reminder">یادآوری</option>
                            <option value="other">سایر</option>
                        </select>
                    </div>

                    <!-- Template Description -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-align-left text-purple-500 ml-2"></i>
                            توضیحات
                        </label>
                        <textarea id="description" name="description" rows="3"
                                  class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none transition"
                                  placeholder="توضیحات مختصری درباره این قالب..."></textarea>
                    </div>
                </div>

                <!-- Message Content -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-comment-alt text-white text-sm"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">محتوای پیام</h2>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600 dark:text-gray-400">تعداد کاراکتر:</span>
                            <span id="characterCount" class="character-counter text-sm font-medium">0</span>
                            <span class="text-sm text-gray-500">/</span>
                            <span class="text-sm text-gray-500">160</span>
                        </div>
                    </div>

                    <!-- Message Textarea -->
                    <div class="mb-6">
              <textarea id="messageContent" name="message" rows="6" required
                        class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none transition"
                        placeholder="متن پیام خود را وارد کنید... از متغیرها مانند {name} استفاده کنید"
                        oninput="updateCharacterCount(); updatePreview()"></textarea>
                        <div id="messageError" class="hidden text-red-500 text-sm mt-1"></div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            <i class="fas fa-info-circle ml-1"></i>
                            برای استفاده از متغیرها، آنها را داخل آکولاد قرار دهید مثل {name}
                        </div>
                    </div>

                    <!-- Quick Variables -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                            <i class="fas fa-magic text-indigo-500 ml-2"></i>
                            متغیرهای سریع
                        </label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                            <button type="button" onclick="insertVariable('name')"
                                    class="variable-tag px-3 py-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition text-sm font-medium">
                                <i class="fas fa-user ml-1"></i>
                                {name}
                            </button>
                            <button type="button" onclick="insertVariable('phone')"
                                    class="variable-tag px-3 py-2 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition text-sm font-medium">
                                <i class="fas fa-phone ml-1"></i>
                                {phone}
                            </button>
                            <button type="button" onclick="insertVariable('email')"
                                    class="variable-tag px-3 py-2 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-800 transition text-sm font-medium">
                                <i class="fas fa-envelope ml-1"></i>
                                {email}
                            </button>
                            <button type="button" onclick="insertVariable('code')"
                                    class="variable-tag px-3 py-2 bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-800 transition text-sm font-medium">
                                <i class="fas fa-key ml-1"></i>
                                {code}
                            </button>
                            <button type="button" onclick="insertVariable('amount')"
                                    class="variable-tag px-3 py-2 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition text-sm font-medium">
                                <i class="fas fa-dollar-sign ml-1"></i>
                                {amount}
                            </button>
                            <button type="button" onclick="insertVariable('date')"
                                    class="variable-tag px-3 py-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 transition text-sm font-medium">
                                <i class="fas fa-calendar ml-1"></i>
                                {date}
                            </button>
                            <button type="button" onclick="insertVariable('link')"
                                    class="variable-tag px-3 py-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-800 transition text-sm font-medium">
                                <i class="fas fa-link ml-1"></i>
                                {link}
                            </button>
                            <button type="button" onclick="showCustomVariableModal()"
                                    class="variable-tag px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition text-sm font-medium">
                                <i class="fas fa-plus ml-1"></i>
                                سفارشی
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-cog text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">تنظیمات</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Status -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-toggle-on text-green-500 ml-2"></i>
                                وضعیت
                            </label>
                            <select id="status" name="status"
                                    class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                                <option value="active">فعال</option>
                                <option value="inactive">غیرفعال</option>
                                <option value="draft">پیش‌نویس</option>
                            </select>
                        </div>

                        <!-- Priority -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-exclamation-triangle text-yellow-500 ml-2"></i>
                                اولویت
                            </label>
                            <select id="priority" name="priority"
                                    class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                                <option value="low">پایین</option>
                                <option value="normal" selected>عادی</option>
                                <option value="high">بالا</option>
                                <option value="urgent">فوری</option>
                            </select>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="mt-6">
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="allowPersonalization" name="allow_personalization"
                                       class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <span class="text-sm text-gray-700 dark:text-gray-300">امکان شخصی‌سازی</span>
                            </label>

                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="trackDelivery" name="track_delivery"
                                       class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <span class="text-sm text-gray-700 dark:text-gray-300">پیگیری تحویل</span>
                            </label>

                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="requireApproval" name="require_approval"
                                       class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <span class="text-sm text-gray-700 dark:text-gray-300">نیاز به تایید</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex gap-4">
                    <button type="button" onclick="testTemplate()"
                            class="px-6 py-3 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 font-medium rounded-xl hover:bg-blue-200 dark:hover:bg-blue-800 transition">
                        <i class="fas fa-paper-plane ml-2"></i>
                        تست ارسال
                    </button>
                    <button type="submit"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-medium rounded-xl hover:from-green-700 hover:to-emerald-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition shadow-lg">
                        <i class="fas fa-check ml-2"></i>
                        <span id="submitButtonText">ایجاد قالب</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Preview Panel -->
        <div class="lg:col-span-1">
            <div class="sticky top-8 space-y-6">

                <!-- Live Preview -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="preview-box p-4">
                        <div class="flex items-center gap-3 text-white">
                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-sm"></i>
                            </div>
                            <h3 class="font-bold">پیش‌نمایش پیام</h3>
                        </div>
                    </div>

                    <div class="p-6">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 min-h-[120px]">
                            <div id="messagePreview" class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                                متن پیام شما اینجا نمایش داده می‌شود...
                            </div>
                        </div>

                        <div class="mt-4 space-y-2">
                            <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
                                <span>طول پیام:</span>
                                <span id="previewLength">0 کاراکتر</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
                                <span>تعداد پیامک:</span>
                                <span id="smsCount">1 پیامک</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
                                <span>متغیرهای شناسایی شده:</span>
                                <span id="variableCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template Tips -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-lightbulb text-white text-sm"></i>
                        </div>
                        <h3 class="font-bold text-gray-900 dark:text-white">نکات مفید</h3>
                    </div>

                    <div class="space-y-3 text-sm text-gray-600 dark:text-gray-400">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check text-green-500 mt-0.5 text-xs"></i>
                            <span>از متغیرها برای شخصی‌سازی استفاده کنید</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check text-green-500 mt-0.5 text-xs"></i>
                            <span>پیام‌های کوتاه‌تر از ۱۶۰ کاراکتر بهتر هستند</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check text-green-500 mt-0.5 text-xs"></i>
                            <span>از زبان ساده و قابل فهم استفاده کنید</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check text-green-500 mt-0.5 text-xs"></i>
                            <span>قبل از ذخیره، قالب را تست کنید</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Templates -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-history text-white text-sm"></i>
                        </div>
                        <h3 class="font-bold text-gray-900 dark:text-white">قالب‌های اخیر</h3>
                    </div>

                    <div class="space-y-3">
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition" onclick="loadTemplate('WELCOME_001')">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">پیام خوش‌آمدگویی</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">WELCOME_001</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition" onclick="loadTemplate('VERIFY_002')">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">کد تایید</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">VERIFY_002</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition" onclick="loadTemplate('PROMO_003')">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">پیشنهاد ویژه</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">PROMO_003</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Variable Modal -->
<div id="customVariableModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">افزودن متغیر سفارشی</h3>
            <button onclick="closeCustomVariableModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نام متغیر</label>
                <input type="text" id="customVariableName"
                       class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                       placeholder="مثال: order_id">
            </div>

            <div class="flex gap-3">
                <button onclick="closeCustomVariableModal()"
                        class="flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                    انصراف
                </button>
                <button onclick="addCustomVariable()"
                        class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    افزودن
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // CSRF Token setup
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Character count and preview update
    function updateCharacterCount() {
        const messageContent = document.getElementById('messageContent').value;
        const characterCount = document.getElementById('characterCount');
        const length = messageContent.length;

        characterCount.textContent = length;

        // Update color based on length
        characterCount.className = 'character-counter text-sm font-medium';
        if (length > 140) {
            characterCount.classList.add('danger');
        } else if (length > 120) {
            characterCount.classList.add('warning');
        }
    }

    // Update live preview
    function updatePreview() {
        const messageContent = document.getElementById('messageContent').value;
        const preview = document.getElementById('messagePreview');
        const previewLength = document.getElementById('previewLength');
        const smsCount = document.getElementById('smsCount');
        const variableCount = document.getElementById('variableCount');

        // Update preview text
        let previewText = messageContent || 'متن پیام شما اینجا نمایش داده می‌شود...';

        // Replace variables with sample data for preview
        previewText = previewText
            .replace(/{name}/g, 'احمد رضایی')
            .replace(/{phone}/g, '09123456789')
            .replace(/{email}/g, 'ahmad@example.com')
            .replace(/{code}/g, '12345')
            .replace(/{amount}/g, '150,000')
            .replace(/{date}/g, '1402/12/15')
            .replace(/{link}/g, 'https://example.com');

        preview.textContent = previewText;

        // Update stats
        const length = messageContent.length;
        previewLength.textContent = `${length} کاراکتر`;

        const smsCountValue = Math.ceil(length / 160) || 1;
        smsCount.textContent = `${smsCountValue} پیامک`;

        const variables = messageContent.match(/{[^}]+}/g) || [];
        variableCount.textContent = variables.length;
    }

    // Insert variable into message
    function insertVariable(variable) {
        const messageContent = document.getElementById('messageContent');
        const cursorPos = messageContent.selectionStart;
        const textBefore = messageContent.value.substring(0, cursorPos);
        const textAfter = messageContent.value.substring(messageContent.selectionEnd);

        messageContent.value = textBefore + `{${variable}}` + textAfter;
        messageContent.focus();
        messageContent.setSelectionRange(cursorPos + variable.length + 2, cursorPos + variable.length + 2);

        updateCharacterCount();
        updatePreview();
    }

    // Validate bodyId
    function validateBodyId(value) {
        const bodyIdError = document.getElementById('bodyIdError');
        const pattern = /^[A-Z0-9_]+$/;

        if (value && !pattern.test(value)) {
            bodyIdError.textContent = 'فقط حروف بزرگ انگلیسی، اعداد و خط تیره مجاز است';
            bodyIdError.classList.remove('hidden');
        } else {
            bodyIdError.classList.add('hidden');
        }
    }

    // Custom variable modal
    function showCustomVariableModal() {
        document.getElementById('customVariableModal').classList.remove('hidden');
        document.getElementById('customVariableName').focus();
    }

    function closeCustomVariableModal() {
        document.getElementById('customVariableModal').classList.add('hidden');
        document.getElementById('customVariableName').value = '';
    }

    function addCustomVariable() {
        const variableName = document.getElementById('customVariableName').value.trim();

        if (!variableName) {
            alert('لطفاً نام متغیر را وارد کنید');
            return;
        }

        if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(variableName)) {
            alert('نام متغیر باید با حرف یا _ شروع شود و فقط شامل حروف، اعداد و _ باشد');
            return;
        }

        insertVariable(variableName);
        closeCustomVariableModal();
    }

    // Load template (for recent templates)
    function loadTemplate(bodyId) {
        if (confirm('آیا می‌خواهید این قالب را بارگذاری کنید؟ تغییرات فعلی از بین خواهد رفت.')) {
            // Mock data for demonstration
            const templates = {
                'WELCOME_001': {
                    name: 'پیام خوش‌آمدگویی',
                    bodyId: 'WELCOME_001',
                    message: 'سلام {name} عزیز! به سامانه ما خوش آمدید.',
                    category: 'welcome',
                    description: 'پیام خوش‌آمدگویی برای کاربران جدید'
                },
                'VERIFY_002': {
                    name: 'کد تایید',
                    bodyId: 'VERIFY_002',
                    message: 'کد تایید شما: {code}',
                    category: 'verification',
                    description: 'ارسال کد تایید برای احراز هویت'
                },
                'PROMO_003': {
                    name: 'پیشنهاد ویژه',
                    bodyId: 'PROMO_003',
                    message: '🎉 {discount}% تخفیف ویژه! کد: {promo_code}',
                    category: 'promotional',
                    description: 'پیام‌های تبلیغاتی و تخفیف'
                }
            };

            const template = templates[bodyId];
            if (template) {
                document.getElementById('templateName').value = template.name;
                document.getElementById('bodyId').value = template.bodyId;
                document.getElementById('messageContent').value = template.message;
                document.getElementById('category').value = template.category;
                document.getElementById('description').value = template.description;

                updateCharacterCount();
                updatePreview();
            }
        }
    }

    // Test template
    function testTemplate() {
        const messageContent = document.getElementById('messageContent').value;

        if (!messageContent.trim()) {
            alert('لطفاً ابتدا متن پیام را وارد کنید');
            return;
        }

        const testPhone = prompt('شماره تلفن برای تست ارسال:');
        if (testPhone) {
            alert(`پیام تست به شماره ${testPhone} ارسال شد`);
        }
    }

    // Save as draft
    function saveAsDraft() {
        const formData = getFormData();
        formData.status = 'draft';

        // Mock save
        alert('قالب به عنوان پیش‌نویس ذخیره شد');
    }

    // Get form data
    function getFormData() {
        return {
            name: document.getElementById('templateName').value.trim(),
            bodyId: document.getElementById('bodyId').value.trim(),
            message: document.getElementById('messageContent').value.trim(),
            category: document.getElementById('category').value,
            description: document.getElementById('description').value.trim(),
            status: document.getElementById('status').value,
            priority: document.getElementById('priority').value,
            allow_personalization: document.getElementById('allowPersonalization').checked,
            track_delivery: document.getElementById('trackDelivery').checked,
            require_approval: document.getElementById('requireApproval').checked
        };
    }

    // Form validation
    function validateForm(data) {
        const errors = [];

        if (!data.name) {
            errors.push('نام قالب الزامی است');
            showError('nameError', 'نام قالب الزامی است');
        }

        if (!data.bodyId) {
            errors.push('شناسه قالب الزامی است');
            showError('bodyIdError', 'شناسه قالب الزامی است');
        } else if (!/^[A-Z0-9_]+$/.test(data.bodyId)) {
            errors.push('شناسه قالب نامعتبر است');
            showError('bodyIdError', 'شناسه قالب نامعتبر است');
        }

        if (!data.message) {
            errors.push('متن پیام الزامی است');
            showError('messageError', 'متن پیام الزامی است');
        }

        return errors;
    }

    // Show error
    function showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');

        setTimeout(() => {
            errorElement.classList.add('hidden');
        }, 5000);
    }

    // Form submission
    document.getElementById('createTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = getFormData();
        const errors = validateForm(formData);

        if (errors.length > 0) {
            alert('لطفاً خطاهای فرم را برطرف کنید:\n' + errors.join('\n'));
            return;
        }

        // Show loading state
        const submitButton = document.querySelector('button[type="submit"]');
        const submitButtonText = document.getElementById('submitButtonText');
        const originalText = submitButtonText.textContent;

        submitButton.disabled = true;
        submitButtonText.innerHTML = '<i class="fas fa-spinner loading-spinner ml-2"></i>در حال ایجاد...';

        // Mock API call
        setTimeout(() => {
            alert('قالب با موفقیت ایجاد شد!');

            // Reset form or redirect
            if (confirm('آیا می‌خواهید قالب جدیدی ایجاد کنید؟')) {
                document.getElementById('createTemplateForm').reset();
                updateCharacterCount();
                updatePreview();
            } else {
                window.location.href = '/admin/message-templates';
            }

            // Restore button state
            submitButton.disabled = false;
            submitButtonText.textContent = originalText;
        }, 2000);
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateCharacterCount();
        updatePreview();

        // Auto-generate bodyId from name
        document.getElementById('templateName').addEventListener('input', function(e) {
            const name = e.target.value;
            const bodyId = document.getElementById('bodyId');

            if (!bodyId.value) {
                const generatedId = name
                    .replace(/[^\w\s]/gi, '')
                    .replace(/\s+/g, '_')
                    .toUpperCase()
                    .substring(0, 20);

                if (generatedId) {
                    bodyId.value = generatedId + '_001';
                }
            }
        });
    });
</script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977a71d620e6c0fd',t:'MTc1NjYyMTQ2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
