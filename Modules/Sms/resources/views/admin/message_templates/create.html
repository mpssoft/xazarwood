<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .variable-tag {
            transition: all 0.3s ease;
        }
        .variable-tag:hover {
            transform: translateY(-1px);
        }
        .character-counter {
            transition: color 0.3s ease;
        }
        .character-counter.warning {
            color: #f59e0b;
        }
        .character-counter.danger {
            color: #ef4444;
        }
        .preview-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 mb-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-plus text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯</h1>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Ù‚Ø§Ù„Ø¨ Ù¾ÛŒØ§Ù…Ú© ÛŒØ§ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="window.history.back()"
                        class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition text-sm font-medium">
                    <i class="fas fa-arrow-right ml-2"></i>
                    Ø¨Ø§Ø²Ú¯Ø´Øª
                </button>
                <button onclick="saveAsDraft()"
                        class="px-4 py-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 transition text-sm font-medium">
                    <i class="fas fa-save ml-2"></i>
                    Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Main Form -->
        <div class="lg:col-span-2">
            <form id="createTemplateForm" class="space-y-8">

                <!-- Basic Information -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-info-circle text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Template Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-tag text-blue-500 ml-2"></i>
                                Ù†Ø§Ù… Ù‚Ø§Ù„Ø¨ *
                            </label>
                            <input type="text" id="templateName" name="name" required
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"
                                   placeholder="Ù†Ø§Ù… Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
                            <div id="nameError" class="hidden text-red-500 text-sm mt-1"></div>
                        </div>

                        <!-- Body ID -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-code text-green-500 ml-2"></i>
                                Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ (bodyId) *
                            </label>
                            <input type="text" id="bodyId" name="bodyId" required
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"
                                   placeholder="Ù…Ø«Ø§Ù„: WELCOME_001"
                                   oninput="validateBodyId(this.value)">
                            <div id="bodyIdError" class="hidden text-red-500 text-sm mt-1"></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø®Ø· ØªÛŒØ±Ù‡ Ù…Ø¬Ø§Ø² Ø§Ø³Øª
                            </div>
                        </div>
                    </div>

                    <!-- Template Category -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-folder text-orange-500 ml-2"></i>
                            Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
                        </label>
                        <select id="category" name="category"
                                class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ...</option>
                            <option value="welcome">Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ</option>
                            <option value="verification">ØªØ§ÛŒÛŒØ¯ Ù‡ÙˆÛŒØª</option>
                            <option value="promotional">ØªØ¨Ù„ÛŒØºØ§ØªÛŒ</option>
                            <option value="transactional">ØªØ±Ø§Ú©Ù†Ø´ÛŒ</option>
                            <option value="notification">Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ</option>
                            <option value="reminder">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</option>
                            <option value="other">Ø³Ø§ÛŒØ±</option>
                        </select>
                    </div>

                    <!-- Template Description -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-align-left text-purple-500 ml-2"></i>
                            ØªÙˆØ¶ÛŒØ­Ø§Øª
                        </label>
                        <textarea id="description" name="description" rows="3"
                                  class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none transition"
                                  placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø®ØªØµØ±ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø§ÛŒÙ† Ù‚Ø§Ù„Ø¨..."></textarea>
                    </div>
                </div>

                <!-- Message Content -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-comment-alt text-white text-sm"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù…</h2>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600 dark:text-gray-400">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø§Ú©ØªØ±:</span>
                            <span id="characterCount" class="character-counter text-sm font-medium">0</span>
                            <span class="text-sm text-gray-500">/</span>
                            <span class="text-sm text-gray-500">160</span>
                        </div>
                    </div>

                    <!-- Message Textarea -->
                    <div class="mb-6">
              <textarea id="messageContent" name="message" rows="6" required
                        class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none transition"
                        placeholder="Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯... Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ Ù…Ø§Ù†Ù†Ø¯ {name} Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯"
                        oninput="updateCharacterCount(); updatePreview()"></textarea>
                        <div id="messageError" class="hidden text-red-500 text-sm mt-1"></div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            <i class="fas fa-info-circle ml-1"></i>
                            Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ØŒ Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø¯Ø§Ø®Ù„ Ø¢Ú©ÙˆÙ„Ø§Ø¯ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ Ù…Ø«Ù„ {name}
                        </div>
                    </div>

                    <!-- Quick Variables -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                            <i class="fas fa-magic text-indigo-500 ml-2"></i>
                            Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±ÛŒØ¹
                        </label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                            <button type="button" onclick="insertVariable('name')"
                                    class="variable-tag px-3 py-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition text-sm font-medium">
                                <i class="fas fa-user ml-1"></i>
                                {name}
                            </button>
                            <button type="button" onclick="insertVariable('phone')"
                                    class="variable-tag px-3 py-2 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition text-sm font-medium">
                                <i class="fas fa-phone ml-1"></i>
                                {phone}
                            </button>
                            <button type="button" onclick="insertVariable('email')"
                                    class="variable-tag px-3 py-2 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-800 transition text-sm font-medium">
                                <i class="fas fa-envelope ml-1"></i>
                                {email}
                            </button>
                            <button type="button" onclick="insertVariable('code')"
                                    class="variable-tag px-3 py-2 bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-800 transition text-sm font-medium">
                                <i class="fas fa-key ml-1"></i>
                                {code}
                            </button>
                            <button type="button" onclick="insertVariable('amount')"
                                    class="variable-tag px-3 py-2 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition text-sm font-medium">
                                <i class="fas fa-dollar-sign ml-1"></i>
                                {amount}
                            </button>
                            <button type="button" onclick="insertVariable('date')"
                                    class="variable-tag px-3 py-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 transition text-sm font-medium">
                                <i class="fas fa-calendar ml-1"></i>
                                {date}
                            </button>
                            <button type="button" onclick="insertVariable('link')"
                                    class="variable-tag px-3 py-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-800 transition text-sm font-medium">
                                <i class="fas fa-link ml-1"></i>
                                {link}
                            </button>
                            <button type="button" onclick="showCustomVariableModal()"
                                    class="variable-tag px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition text-sm font-medium">
                                <i class="fas fa-plus ml-1"></i>
                                Ø³ÙØ§Ø±Ø´ÛŒ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-cog text-white text-sm"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Status -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-toggle-on text-green-500 ml-2"></i>
                                ÙˆØ¶Ø¹ÛŒØª
                            </label>
                            <select id="status" name="status"
                                    class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                                <option value="active">ÙØ¹Ø§Ù„</option>
                                <option value="inactive">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
                                <option value="draft">Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³</option>
                            </select>
                        </div>

                        <!-- Priority -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-exclamation-triangle text-yellow-500 ml-2"></i>
                                Ø§ÙˆÙ„ÙˆÛŒØª
                            </label>
                            <select id="priority" name="priority"
                                    class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                                <option value="low">Ù¾Ø§ÛŒÛŒÙ†</option>
                                <option value="normal" selected>Ø¹Ø§Ø¯ÛŒ</option>
                                <option value="high">Ø¨Ø§Ù„Ø§</option>
                                <option value="urgent">ÙÙˆØ±ÛŒ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="mt-6">
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="allowPersonalization" name="allow_personalization"
                                       class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <span class="text-sm text-gray-700 dark:text-gray-300">Ø§Ù…Ú©Ø§Ù† Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ</span>
                            </label>

                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="trackDelivery" name="track_delivery"
                                       class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <span class="text-sm text-gray-700 dark:text-gray-300">Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ØªØ­ÙˆÛŒÙ„</span>
                            </label>

                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="requireApproval" name="require_approval"
                                       class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <span class="text-sm text-gray-700 dark:text-gray-300">Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ§ÛŒÛŒØ¯</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex gap-4">
                    <button type="button" onclick="testTemplate()"
                            class="px-6 py-3 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 font-medium rounded-xl hover:bg-blue-200 dark:hover:bg-blue-800 transition">
                        <i class="fas fa-paper-plane ml-2"></i>
                        ØªØ³Øª Ø§Ø±Ø³Ø§Ù„
                    </button>
                    <button type="submit"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-medium rounded-xl hover:from-green-700 hover:to-emerald-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition shadow-lg">
                        <i class="fas fa-check ml-2"></i>
                        <span id="submitButtonText">Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Preview Panel -->
        <div class="lg:col-span-1">
            <div class="sticky top-8 space-y-6">

                <!-- Live Preview -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="preview-box p-4">
                        <div class="flex items-center gap-3 text-white">
                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-sm"></i>
                            </div>
                            <h3 class="font-bold">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…</h3>
                        </div>
                    </div>

                    <div class="p-6">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 min-h-[120px]">
                            <div id="messagePreview" class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                                Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...
                            </div>
                        </div>

                        <div class="mt-4 space-y-2">
                            <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
                                <span>Ø·ÙˆÙ„ Ù¾ÛŒØ§Ù…:</span>
                                <span id="previewLength">0 Ú©Ø§Ø±Ø§Ú©ØªØ±</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
                                <span>ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…Ú©:</span>
                                <span id="smsCount">1 Ù¾ÛŒØ§Ù…Ú©</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
                                <span>Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡:</span>
                                <span id="variableCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template Tips -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-lightbulb text-white text-sm"></i>
                        </div>
                        <h3 class="font-bold text-gray-900 dark:text-white">Ù†Ú©Ø§Øª Ù…ÙÛŒØ¯</h3>
                    </div>

                    <div class="space-y-3 text-sm text-gray-600 dark:text-gray-400">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check text-green-500 mt-0.5 text-xs"></i>
                            <span>Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check text-green-500 mt-0.5 text-xs"></i>
                            <span>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ø§Ø² Û±Û¶Û° Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ù‡ØªØ± Ù‡Ø³ØªÙ†Ø¯</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check text-green-500 mt-0.5 text-xs"></i>
                            <span>Ø§Ø² Ø²Ø¨Ø§Ù† Ø³Ø§Ø¯Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ ÙÙ‡Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check text-green-500 mt-0.5 text-xs"></i>
                            <span>Ù‚Ø¨Ù„ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ØŒ Ù‚Ø§Ù„Ø¨ Ø±Ø§ ØªØ³Øª Ú©Ù†ÛŒØ¯</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Templates -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-history text-white text-sm"></i>
                        </div>
                        <h3 class="font-bold text-gray-900 dark:text-white">Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</h3>
                    </div>

                    <div class="space-y-3">
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition" onclick="loadTemplate('WELCOME_001')">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">WELCOME_001</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition" onclick="loadTemplate('VERIFY_002')">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">VERIFY_002</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition" onclick="loadTemplate('PROMO_003')">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ÙˆÛŒÚ˜Ù‡</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">PROMO_003</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Variable Modal -->
<div id="customVariableModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Ø§ÙØ²ÙˆØ¯Ù† Ù…ØªØºÛŒØ± Ø³ÙØ§Ø±Ø´ÛŒ</h3>
            <button onclick="closeCustomVariableModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ù†Ø§Ù… Ù…ØªØºÛŒØ±</label>
                <input type="text" id="customVariableName"
                       class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                       placeholder="Ù…Ø«Ø§Ù„: order_id">
            </div>

            <div class="flex gap-3">
                <button onclick="closeCustomVariableModal()"
                        class="flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                    Ø§Ù†ØµØ±Ø§Ù
                </button>
                <button onclick="addCustomVariable()"
                        class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    Ø§ÙØ²ÙˆØ¯Ù†
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // CSRF Token setup
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Character count and preview update
    function updateCharacterCount() {
        const messageContent = document.getElementById('messageContent').value;
        const characterCount = document.getElementById('characterCount');
        const length = messageContent.length;

        characterCount.textContent = length;

        // Update color based on length
        characterCount.className = 'character-counter text-sm font-medium';
        if (length > 140) {
            characterCount.classList.add('danger');
        } else if (length > 120) {
            characterCount.classList.add('warning');
        }
    }

    // Update live preview
    function updatePreview() {
        const messageContent = document.getElementById('messageContent').value;
        const preview = document.getElementById('messagePreview');
        const previewLength = document.getElementById('previewLength');
        const smsCount = document.getElementById('smsCount');
        const variableCount = document.getElementById('variableCount');

        // Update preview text
        let previewText = messageContent || 'Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...';

        // Replace variables with sample data for preview
        previewText = previewText
            .replace(/{name}/g, 'Ø§Ø­Ù…Ø¯ Ø±Ø¶Ø§ÛŒÛŒ')
            .replace(/{phone}/g, '09123456789')
            .replace(/{email}/g, 'ahmad@example.com')
            .replace(/{code}/g, '12345')
            .replace(/{amount}/g, '150,000')
            .replace(/{date}/g, '1402/12/15')
            .replace(/{link}/g, 'https://example.com');

        preview.textContent = previewText;

        // Update stats
        const length = messageContent.length;
        previewLength.textContent = `${length} Ú©Ø§Ø±Ø§Ú©ØªØ±`;

        const smsCountValue = Math.ceil(length / 160) || 1;
        smsCount.textContent = `${smsCountValue} Ù¾ÛŒØ§Ù…Ú©`;

        const variables = messageContent.match(/{[^}]+}/g) || [];
        variableCount.textContent = variables.length;
    }

    // Insert variable into message
    function insertVariable(variable) {
        const messageContent = document.getElementById('messageContent');
        const cursorPos = messageContent.selectionStart;
        const textBefore = messageContent.value.substring(0, cursorPos);
        const textAfter = messageContent.value.substring(messageContent.selectionEnd);

        messageContent.value = textBefore + `{${variable}}` + textAfter;
        messageContent.focus();
        messageContent.setSelectionRange(cursorPos + variable.length + 2, cursorPos + variable.length + 2);

        updateCharacterCount();
        updatePreview();
    }

    // Validate bodyId
    function validateBodyId(value) {
        const bodyIdError = document.getElementById('bodyIdError');
        const pattern = /^[A-Z0-9_]+$/;

        if (value && !pattern.test(value)) {
            bodyIdError.textContent = 'ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø®Ø· ØªÛŒØ±Ù‡ Ù…Ø¬Ø§Ø² Ø§Ø³Øª';
            bodyIdError.classList.remove('hidden');
        } else {
            bodyIdError.classList.add('hidden');
        }
    }

    // Custom variable modal
    function showCustomVariableModal() {
        document.getElementById('customVariableModal').classList.remove('hidden');
        document.getElementById('customVariableName').focus();
    }

    function closeCustomVariableModal() {
        document.getElementById('customVariableModal').classList.add('hidden');
        document.getElementById('customVariableName').value = '';
    }

    function addCustomVariable() {
        const variableName = document.getElementById('customVariableName').value.trim();

        if (!variableName) {
            alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…ØªØºÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            return;
        }

        if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(variableName)) {
            alert('Ù†Ø§Ù… Ù…ØªØºÛŒØ± Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø­Ø±Ù ÛŒØ§ _ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯ Ùˆ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ _ Ø¨Ø§Ø´Ø¯');
            return;
        }

        insertVariable(variableName);
        closeCustomVariableModal();
    }

    // Load template (for recent templates)
    function loadTemplate(bodyId) {
        if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù‚Ø§Ù„Ø¨ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯ØŸ ØªØºÛŒÛŒØ±Ø§Øª ÙØ¹Ù„ÛŒ Ø§Ø² Ø¨ÛŒÙ† Ø®ÙˆØ§Ù‡Ø¯ Ø±ÙØª.')) {
            // Mock data for demonstration
            const templates = {
                'WELCOME_001': {
                    name: 'Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ',
                    bodyId: 'WELCOME_001',
                    message: 'Ø³Ù„Ø§Ù… {name} Ø¹Ø²ÛŒØ²! Ø¨Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.',
                    category: 'welcome',
                    description: 'Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯'
                },
                'VERIFY_002': {
                    name: 'Ú©Ø¯ ØªØ§ÛŒÛŒØ¯',
                    bodyId: 'VERIFY_002',
                    message: 'Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§: {code}',
                    category: 'verification',
                    description: 'Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª'
                },
                'PROMO_003': {
                    name: 'Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ÙˆÛŒÚ˜Ù‡',
                    bodyId: 'PROMO_003',
                    message: 'ğŸ‰ {discount}% ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡! Ú©Ø¯: {promo_code}',
                    category: 'promotional',
                    description: 'Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ØªØ¨Ù„ÛŒØºØ§ØªÛŒ Ùˆ ØªØ®ÙÛŒÙ'
                }
            };

            const template = templates[bodyId];
            if (template) {
                document.getElementById('templateName').value = template.name;
                document.getElementById('bodyId').value = template.bodyId;
                document.getElementById('messageContent').value = template.message;
                document.getElementById('category').value = template.category;
                document.getElementById('description').value = template.description;

                updateCharacterCount();
                updatePreview();
            }
        }
    }

    // Test template
    function testTemplate() {
        const messageContent = document.getElementById('messageContent').value;

        if (!messageContent.trim()) {
            alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            return;
        }

        const testPhone = prompt('Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§Ø±Ø³Ø§Ù„:');
        if (testPhone) {
            alert(`Ù¾ÛŒØ§Ù… ØªØ³Øª Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ ${testPhone} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`);
        }
    }

    // Save as draft
    function saveAsDraft() {
        const formData = getFormData();
        formData.status = 'draft';

        // Mock save
        alert('Ù‚Ø§Ù„Ø¨ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
    }

    // Get form data
    function getFormData() {
        return {
            name: document.getElementById('templateName').value.trim(),
            bodyId: document.getElementById('bodyId').value.trim(),
            message: document.getElementById('messageContent').value.trim(),
            category: document.getElementById('category').value,
            description: document.getElementById('description').value.trim(),
            status: document.getElementById('status').value,
            priority: document.getElementById('priority').value,
            allow_personalization: document.getElementById('allowPersonalization').checked,
            track_delivery: document.getElementById('trackDelivery').checked,
            require_approval: document.getElementById('requireApproval').checked
        };
    }

    // Form validation
    function validateForm(data) {
        const errors = [];

        if (!data.name) {
            errors.push('Ù†Ø§Ù… Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            showError('nameError', 'Ù†Ø§Ù… Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
        }

        if (!data.bodyId) {
            errors.push('Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            showError('bodyIdError', 'Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
        } else if (!/^[A-Z0-9_]+$/.test(data.bodyId)) {
            errors.push('Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
            showError('bodyIdError', 'Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
        }

        if (!data.message) {
            errors.push('Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            showError('messageError', 'Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
        }

        return errors;
    }

    // Show error
    function showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');

        setTimeout(() => {
            errorElement.classList.add('hidden');
        }, 5000);
    }

    // Form submission
    document.getElementById('createTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = getFormData();
        const errors = validateForm(formData);

        if (errors.length > 0) {
            alert('Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ÛŒ ÙØ±Ù… Ø±Ø§ Ø¨Ø±Ø·Ø±Ù Ú©Ù†ÛŒØ¯:\n' + errors.join('\n'));
            return;
        }

        // Show loading state
        const submitButton = document.querySelector('button[type="submit"]');
        const submitButtonText = document.getElementById('submitButtonText');
        const originalText = submitButtonText.textContent;

        submitButton.disabled = true;
        submitButtonText.innerHTML = '<i class="fas fa-spinner loading-spinner ml-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯...';

        // Mock API call
        setTimeout(() => {
            alert('Ù‚Ø§Ù„Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!');

            // Reset form or redirect
            if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯ØŸ')) {
                document.getElementById('createTemplateForm').reset();
                updateCharacterCount();
                updatePreview();
            } else {
                window.location.href = '/admin/message-templates';
            }

            // Restore button state
            submitButton.disabled = false;
            submitButtonText.textContent = originalText;
        }, 2000);
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateCharacterCount();
        updatePreview();

        // Auto-generate bodyId from name
        document.getElementById('templateName').addEventListener('input', function(e) {
            const name = e.target.value;
            const bodyId = document.getElementById('bodyId');

            if (!bodyId.value) {
                const generatedId = name
                    .replace(/[^\w\s]/gi, '')
                    .replace(/\s+/g, '_')
                    .toUpperCase()
                    .substring(0, 20);

                if (generatedId) {
                    bodyId.value = generatedId + '_001';
                }
            }
        });
    });
</script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977a71d620e6c0fd',t:'MTc1NjYyMTQ2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
